<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formation Manager - WeN√©goce</title>
  
  <!--
  ============================================================================
  FORMATION MANAGER v4.4.7 - CHANGELOG
  ============================================================================
  
  Version 4.4.7 (26 novembre 2025) - Compatibilit√© Chrome pour envoi multiple d'emails
  ------------------------------------------------------------------------------------
  üî¥ CORRECTION CRITIQUE : Chrome bloque les emails multiples
     - D√©tection automatique du navigateur Chrome
     - Mode interactif pour Chrome : Confirmation avant chaque email
     - Mode automatique conserv√© pour Safari/Firefox
  
  ‚ú® Fonctionnement Chrome :
     - Premier email : Ouvre imm√©diatement
     - Emails suivants : Demande confirmation "Envoyer l'email suivant ?"
     - Possibilit√© d'arr√™ter l'envoi √† tout moment
     - Feedback clair : "Email X/Y envoy√©"
  
  ‚ú® Fonctionnement Safari/Firefox :
     - Mode automatique conserv√© (d√©lai 2 secondes entre emails)
     - Tous les emails s'ouvrent successivement
     - Aucun changement par rapport √† v4.4.6
  
  üêõ R√©solution du probl√®me :
     - Chrome : Un seul email s'ouvrait ‚Üí Tous les emails s'ouvrent maintenant ‚úÖ
     - Solution adapt√©e aux restrictions de s√©curit√© Chrome
     - Exp√©rience utilisateur optimale selon le navigateur
  
  üìã D√©tails techniques :
     - D√©tection : /Chrome/.test(navigator.userAgent)
     - Mode Chrome : Fonction r√©cursive avec confirm()
     - Mode autres : setTimeout() avec d√©lai 2s
  
  Version 4.4.6 (26 novembre 2025) - Correction d√©calage date d'un jour
  ----------------------------------------------------------------------
  üî¥ CORRECTION CRITIQUE : Probl√®me de fuseau horaire
     - Modification de toDateISOFromInput() pour retirer le "Z" (UTC)
     - Envoi de la date sans heure : "2025-11-26" au lieu de "2025-11-26T00:00:00Z"
     - SharePoint traite maintenant la date comme heure locale
  
  üêõ R√©solution du probl√®me :
     - Saisie : 26 novembre ‚Üí Affichage : 26 novembre ‚úÖ (avant : 25 novembre ‚ùå)
     - Plus de d√©calage d'un jour dans SharePoint et l'application
     - Dates coh√©rentes entre saisie et affichage
  
  üìã D√©tails techniques :
     - Avant : "2025-11-26T00:00:00Z" (minuit UTC = 23h la veille en heure de Paris)
     - Apr√®s : "2025-11-26" (date seule, interpr√©t√©e en heure locale)
  
  Version 4.4.5 (26 novembre 2025) - Correction r√©f√©rences fonctions obsol√®tes
  ----------------------------------------------------------------------------
  üî¥ CORRECTION CRITIQUE : ReferenceError openReminderModal
     - Suppression des expositions window de 4 fonctions obsol√®tes :
       * window.openReminderModal (supprim√©e en v4.4.1)
       * window.closeReminderModal (supprim√©e en v4.4.1)
       * window.sendReminder (supprim√©e en v4.4.1)
       * window.sendIndividualEmail (supprim√©e en v4.4.1)
  
  üêõ R√©solution de l'erreur :
     - "Can't find variable: openReminderModal" ‚Üí Corrig√©e
     - Nettoyage complet des r√©f√©rences aux fonctions supprim√©es
     - Application stable sans erreurs console
  
  Version 4.4.4 (26 novembre 2025) - Correction envoi d'emails multiples
  -----------------------------------------------------------------------
  üî¥ CORRECTION CRITIQUE : Envoi tous les mails
     - Remplacement de window.open() par cr√©ation de liens <a> temporaires
     - Augmentation du d√©lai entre emails : 500ms ‚Üí 2000ms (2 secondes)
     - Ajout d'un message d'information sur le temps estim√©
     - Meilleure compatibilit√© avec les navigateurs modernes
  
  ‚ú® Am√©liorations UX :
     - Les emails s'ouvrent maintenant successivement un par un
     - Feedback visuel avec alert indiquant le nombre d'emails
     - Logs d√©taill√©s pour chaque ouverture d'email
  
  üêõ R√©solution du probl√®me :
     - "Un seul email s'ouvre" ‚Üí Corrig√©
     - Tous les emails s'ouvrent maintenant s√©quentiellement
     - D√©lai suffisant pour que le syst√®me d'exploitation ouvre chaque client email
  
  Version 4.4.3 (26 novembre 2025) - Correction "Script error"
  -------------------------------------------------------------
  üî¥ CORRECTION CRITIQUE : Chargement MSAL
     - Suppression de async defer sur le script MSAL
     - Chargement synchrone pour √©viter les erreurs de timing
     - Ajout d'un timeout (5s) dans le m√©canisme d'attente MSAL
     - Ajout d'un gestionnaire d'erreurs global pour debug
     - Ajout d'un gestionnaire pour les promesses non g√©r√©es
  
  üêõ R√©solution de l'erreur :
     - "Uncaught Error: Script error." ‚Üí Corrig√©e
     - MSAL se charge maintenant de mani√®re fiable
     - Meilleure gestion des erreurs avec logs d√©taill√©s
  
  Version 4.4.2 (26 novembre 2025) - Am√©lioration de l'affichage des stagiaires
  -----------------------------------------------------------------------------
  ‚ú® Am√©lioration de la page "Valider les pr√©sences" :
     - Affichage am√©lior√© de chaque stagiaire dans une carte distincte
     - Nom du stagiaire plus grand et plus visible (20px, en bleu)
     - Espacement am√©lior√© entre les cartes de stagiaires
     - Bouton "Envoi du mail" mieux styl√© et align√© √† droite
     - Labels "Pr√©sence" et "Commentaire" en gras pour meilleure lisibilit√©
     - Zone de commentaire agrandie (3 lignes au lieu de 2)
     - Effet hover sur les cartes de stagiaires
  
  üìã Structure am√©lior√©e :
     - Chaque stagiaire appara√Æt dans une carte bien d√©limit√©e visuellement
     - Tous les stagiaires s'affichent dans une liste scrollable
     - Design coh√©rent avec la capture d'√©cran de r√©f√©rence
  
  Version 4.4.1 (26 novembre 2025) - Corrections critiques et nettoyage
  ----------------------------------------------------------------------
  üî¥ CORRECTION CRITIQUE : Logger r√©cursif corrig√©
     - logger.warn appelait logger.warn (stack overflow)
     - logger.error appelait logger.error (stack overflow)
     - Remplac√© par console.warn et console.error natifs
  
  üßπ Nettoyage du code :
     - Suppression de sendIndividualEmail() (obsol√®te)
     - Suppression de sendReminder() (obsol√®te)
     - Suppression de openReminderModal() (obsol√®te)
     - Suppression de closeReminderModal() (obsol√®te)
     - Suppression de WEBHOOK_AZURE_SEND_EMAIL (inexistant)
     - Suppression de BASE_LINK (non utilis√©)
     - Suppression du script xlsx.full.min.js (non utilis√©)
  
  üìã Optimisation des constantes :
     - Suppression de DOM_IDS.STAGIAIRE_SECTION (non utilis√©)
     - Suppression de DOM_IDS.PRESENCE_FORM (non utilis√©)
     - Suppression de DOM_IDS.FORMATIONS_LIST (non utilis√©)
  
  ‚ú® Coh√©rence du code :
     - Remplacement de tous les console.log restants par logger.debug
     - Conservation uniquement de envoyerEmailStagiaire() et envoyerTousEmails()
  
  Version 4.4.0 (26 novembre 2025) - Refactoring et optimisation du code
  -----------------------------------------------------------------------
  ‚úÖ Syst√®me de logging conditionnel (DEBUG_MODE)
  ‚úÖ Constantes DOM pour les IDs d'√©l√©ments (DOM_IDS)
  ‚úÖ Fonctions utilitaires r√©utilisables :
     - parseIfJSON() : Parse s√©curis√© des cha√Ænes JSON
     - extractSharePointValue() : Extraction des objets SharePoint Choice
     - getElement() : R√©cup√©ration d'√©l√©ments DOM avec logging
     - toggleElement() : Affichage/masquage simplifi√©
     - formatDateFR() : Formatage de dates en fran√ßais
     - delay() : Promise-based setTimeout
  ‚úÖ Refactoring de displayAttestation() :
     - Utilisation des fonctions utilitaires
     - Code plus lisible et maintenable
     - Configuration des emojis en objet
  ‚úÖ Refactoring de transformAzureFormation() :
     - √âlimination du code dupliqu√©
     - Utilisation de extractSharePointValue()
  ‚úÖ Optimisations performance :
     - Chargement async/defer du script MSAL
     - R√©duction des manipulations DOM
  ‚úÖ Am√©lioration de la qualit√© du code :
     - Remplacement console.log ‚Üí logger.debug
     - Remplacement console.error ‚Üí logger.error  
     - Remplacement console.warn ‚Üí logger.warn
     - Commentaires et documentation am√©lior√©s
  
  Version 4.3.13 (26 novembre 2025)
  ---------------------------------
  ‚úÖ Authentification Microsoft 365 obligatoire pour les formateurs
  ‚úÖ Masquage de l'enqu√™te de satisfaction pour les stagiaires absents
  ‚úÖ Normalisation du champ Presence (objets SharePoint Choice)
  ‚úÖ R√©duction du logo Formation Manager de 10%
  
  Version 4.3.9-4.3.11 (25 novembre 2025)
  ---------------------------------------
  ‚úÖ Correction des URLs des Logic Apps Azure
  ‚úÖ Impl√©mentation du flux de cr√©ation de pr√©sences
  ‚úÖ Gestion robuste des donn√©es SharePoint
  
  Notes importantes :
  - DEBUG_MODE = false en production (voir ligne ~487)
  - URLs de webhooks Azure √† s√©curiser (voir √©valuation du code)
  - Architecture monolithique √† refactorer √† terme
  
  ============================================================================
  -->

  <!-- Favicon pour √©viter 404 console -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

  <!-- MSAL via unpkg (plus fiable) -->
  <script src="https://unpkg.com/@azure/msal-browser@3.21.0/lib/msal-browser.min.js" crossorigin="anonymous"></script>
  
  <!-- Attendre le chargement de MSAL -->
  <script>
    window.__msalReady = new Promise(function(resolve, reject) {
      if (typeof msal !== 'undefined') {
        resolve();
      } else {
        var attempts = 0;
        var maxAttempts = 100; // 5 secondes max
        var checkMsal = setInterval(function() {
          attempts++;
          if (typeof msal !== 'undefined') {
            clearInterval(checkMsal);
            resolve();
          } else if (attempts >= maxAttempts) {
            clearInterval(checkMsal);
            reject(new Error('MSAL n\'a pas pu √™tre charg√© apr√®s 5 secondes'));
          }
        }, 50);
      }
    });
  </script>

  <!-- Styles V3.2 (look & feel WeN√©goce - inchang√©) -->
  <style>
    :root{
      --brand:#3270AF; /* primaire WeN√©goce */
      --brand-600:#2b66a3;
      --brand-50:#e7f3ff;
      --text:#1f2937;
      --muted:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --success:#28a745;
      --warning:#ff9800;
      --danger:#dc3545;
      --radius:12px;
      --shadow:0 6px 14px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.04);
      --shadow-sm:0 2px 8px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(50,112,175,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:#F0F7FE;background-attachment:fixed;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;line-height:1.45}
    img{max-width:100%;height:auto}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .header{display:flex;gap:28px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow-sm)}

    /* Nouveau : User info et login button */
    .auth-section{display:flex;align-items:center;gap:12px;margin-left:auto}
    .user-info{display:flex;align-items:center;gap:10px;padding:0;background:transparent;border-radius:8px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:15px;box-shadow:0 2px 8px rgba(50,112,175,0.3)}
    .user-name{font-size:14px;color:var(--text);font-weight:600}
    .btn-login{background:var(--brand);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s}
    .btn-login:hover{background:var(--brand-600)}
    .btn-logout{background:transparent;color:var(--brand);border:1px solid var(--brand);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;transition:.2s}
    .btn-logout:hover{background:var(--brand-50)}

    .tabs{display:flex;gap:10px;margin:18px 0 12px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--border);background:var(--card);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s box-shadow,.2s transform,.2s background;box-shadow:var(--shadow-sm);font-weight:600;color:var(--text)}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:var(--shadow)}

    .content .tab-content{display:none}
    .content .tab-content.active{display:block}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm)}

    .form-group{margin-bottom:16px}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="date"],input[type="time"],textarea{
      width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;transition:.2s border,.2s box-shadow;font-size:14px
    }
    input:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--focus)}
    input.valid{border-color:var(--success) !important}
    input.invalid{border-color:var(--danger) !important}

    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}

    .btn{background:var(--brand);color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow-sm);transition:.2s transform,.2s box-shadow}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#6b7280}
    .btn-success{background:var(--success)}
    .btn-edit{background:#0ea5e9;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-remove{background:#ef4444;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}

    .switch-container{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:52px;height:30px;display:inline-block}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.2s;border-radius:999px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:4px;background:#fff;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:var(--brand)}
    .switch input:checked + .slider:before{transform:translateX(22px)}
    .switch-label{font-weight:600;color:#6b7280}
    .switch-label.active{color:var(--brand)}

    .alert{padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .alert-info{background:#eef6ff;border-color:#dbeafe;color:#1e3a8a}
    .alert-success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .alert-warning{background:#fff7ed;border-color:#ffedd5;color:#7c2d12}

    .info-display{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 12px}
    .info-row{display:grid;grid-template-columns:220px 1fr;gap:12px;padding:8px 4px;border-bottom:1px dashed #edf2f7}
    .info-row:last-child{border-bottom:none}
    .info-label{color:var(--muted);font-weight:600}

    .stagiaire-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:var(--shadow-sm);transition:.2s}
    .stagiaire-item:hover{box-shadow:var(--shadow)}
    .stagiaire-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .stagiaire-number{font-weight:700;color:var(--brand);font-size:20px}

    .radio-group{display:flex;gap:14px;flex-wrap:wrap}
    .radio-item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#fff}
    .radio-item input[type="radio"]{accent-color:var(--brand)}

    .stars{display:flex;gap:6px;font-size:32px;cursor:pointer;user-select:none}
    .star{color:#d1d5db;transition:.15s}
    .star.active,.star:hover{color:#fbbf24}

    .presence-radio-group{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .presence-item{flex:1;min-width:140px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;transition:.2s;background:#fff}
    .presence-item:hover{border-color:var(--brand);transform:scale(1.02)}
    .presence-item input[type="radio"]{margin-right:8px;accent-color:var(--brand)}
    .presence-item input[type="radio"]:checked + label{font-weight:600;color:var(--brand)}

    .email-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin:12px 0;font-family:inherit}
    .email-link{display:block;padding:12px;background:var(--brand);color:#fff;text-decoration:none;border-radius:8px;text-align:center;margin:10px 0;font-weight:600;transition:.2s}
    .email-link:hover{background:var(--brand-600);transform:translateY(-1px)}

    .formation-card{border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;box-shadow:var(--shadow-sm);background:var(--card);overflow:hidden;transition:.2s}
    .formation-card:hover{box-shadow:var(--shadow)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card);border-radius:var(--radius);max-width:600px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-header{background:var(--brand);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-radius:var(--radius) var(--radius) 0 0}
    .modal-header h3{margin:0}
    .modal-body{padding:18px}
    .btn-icon{background:transparent;border:none;font-size:22px;cursor:pointer;color:inherit;padding:0;transition:.2s}
    .btn-icon:hover{opacity:.8}

    textarea{resize:vertical;font-family:inherit}
    small{display:block;margin-top:4px;color:var(--muted)}
    .error-message{color:var(--danger);font-size:13px;margin-top:4px}

    .loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:16px}
    .loading-screen.active{display:flex}
    .spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}

    .version-info{text-align:center;padding:16px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);margin-top:32px}
    .version-number{font-weight:700;color:var(--brand);font-size:14px;margin-bottom:4px}
    .version-date{margin-bottom:8px}
    .copyright{font-size:12px;line-height:1.5}

    @media(max-width:768px){
      .row{grid-template-columns:1fr}
      .info-row{grid-template-columns:1fr;gap:4px}
      .header{flex-direction:column;text-align:center}
      .auth-section{margin-left:0;width:100%;justify-content:center}
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="spinner"></div>
    <div style="color:var(--brand);font-weight:600">Chargement...</div>
  </div>

  <div class="container">
    <!-- Logo WeN√©goce au-dessus du header -->
    <div style="margin-bottom: 12px;">
      <img src="https://back.wenegoce.fr/uploads/0406_Logo_We_Negoce_avec_We_Soft_DEFINITIF_502368ceeb.png" alt="WeN√©goce" style="width: 230px; cursor: pointer; transition: transform 0.2s;" onclick="resetForm()" title="Retour au formulaire vierge">
    </div>

    <div class="header">
      <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
        <img src="https://back.wenegoce.fr/uploads/logo_Formation_Manager_521b78e5c4.png" alt="Formation Manager" style="height: 62.37px; cursor: pointer;" onclick="resetForm()" title="Retour au formulaire vierge">
      </div>
      <div class="auth-section" id="authSection">
        <!-- Sera rempli dynamiquement par JS -->
      </div>
    </div>

    <!-- Navigation tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="nouveau">‚ûï Cr√©er une formation</button>
      <button class="tab" data-tab="formations">üìã Historique</button>
      <button class="tab" data-tab="stagiaire" style="display:none">üë§ Espace Stagiaire</button>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- NOUVEAU -->
      <div id="nouveau" class="tab-content active">
        <div id="formSection">
          <form id="formateurForm" class="card" style="padding:18px;">
            <div class="form-group">
              <label>Raison sociale du client *</label>
              <input type="text" id="raisonSociale" placeholder="Ex: Entreprise XYZ" required>
            </div>
            <div class="form-group">
              <label>Th√®me de la formation *</label>
              <input type="text" id="theme" placeholder="Ex: Gestion de projet" required>
            </div>
            <div class="form-group">
              <label>R√©f√©rence JIRA (optionnel)</label>
              <input type="text" id="referenceJira" placeholder="Ex: TIC-123">
            </div>
            <div class="form-group">
              <label>Nom du formateur *</label>
              <input type="text" id="nomFormateur" placeholder="Ex: Jean Dupont" required>
              <small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">
                üí° Votre nom est pr√©-rempli par d√©faut. Vous pouvez le modifier si besoin.
              </small>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Date de la formation *</label>
                <input type="date" id="dateFormation" required>
              </div>
              <div class="form-group">
                <label>Type de formation *</label>
                <div class="switch-container">
                  <span class="switch-label active" id="labelPresentiel">Pr√©sentiel</span>
                  <label class="switch">
                    <input type="checkbox" id="typeFormationToggle">
                    <span class="slider"></span>
                  </label>
                  <span class="switch-label" id="labelVisio">Visio</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Heure de d√©but *</label>
                <input type="time" id="heureDebut" value="09:00" required>
              </div>
              <div class="form-group">
                <label>Heure de fin *</label>
                <input type="time" id="heureFin" value="17:00" required>
              </div>
            </div>

            <h3 style="margin:22px 0 12px;color:var(--brand);">Stagiaires</h3>
            <div id="stagiairesList"></div>
            <button type="button" id="btnAddStagiaire" class="btn btn-secondary" style="margin-top:12px">‚ûï Ajouter un stagiaire</button>
            <div style="margin-top:18px">
              <button type="submit" class="btn">üíæ Enregistrer la formation</button>
            </div>
          </form>
        </div>
        
        <!-- Section de validation des pr√©sences (cach√©e par d√©faut) -->
        <div id="validationPresenceSection" style="display:none">
          <div class="card" style="padding:18px;">
            <div style="margin-bottom:16px">
              <h2 style="margin:0;color:var(--brand)">‚úÖ Valider les pr√©sences</h2>
            </div>
            
            <div id="formationInfoValidation" class="info-display" style="margin-bottom:20px"></div>
            
            <!-- Mod√®le d'email -->
            <div style="background:#e7f3ff;padding:20px;border-radius:8px;border-left:4px solid var(--brand);margin-bottom:20px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <strong style="color:var(--brand)">üìß Mod√®le d'email</strong>
                <button class="btn-edit" onclick="openEmailModal()">‚úèÔ∏è Personnaliser l'email</button>
              </div>
              <div id="emailTemplatePreview" style="padding:15px;background:white;border-radius:8px">
                <div style="margin-bottom:10px"><strong>Objet :</strong> <span id="emailSubjectPreview"></span></div>
                <div style="white-space:pre-wrap;color:#666;font-size:14px" id="emailBodyPreview"></div>
              </div>
            </div>
            
            <h3 style="color:var(--brand);margin-bottom:12px">Liste des stagiaires</h3>
            <div id="stagiairePresenceList"></div>
            
            <div style="margin-top:20px">
              <button class="btn" onclick="envoyerTousEmails()">üìß Envoi tous les mails</button>
            </div>
          </div>
        </div>
      </div>

      <!-- FORMATIONS -->
      <div id="formations" class="tab-content">
        <div class="card" style="padding:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px">
            <h2 style="margin:0;color:var(--brand)">üìã Historique des formations</h2>
            <button class="btn" onclick="loadFormationsTab()">üîÑ Actualiser</button>
          </div>
          <div id="formationsList">Chargement...</div>
        </div>
      </div>

      <!-- STAGIAIRE -->
      <div id="stagiaire" class="tab-content">
        <!-- Section 1 : Attestation de pr√©sence -->
        <div class="card" style="padding:18px;margin-bottom:20px">
          <h2 style="color:var(--brand);margin-bottom:16px">üìú Attestation de pr√©sence</h2>
          <div id="attestationPresence" class="info-display">
            <!-- Sera rempli dynamiquement -->
          </div>
        </div>

        <!-- Section 2 : Enqu√™te de satisfaction -->
        <div id="satisfactionSection" class="card" style="padding:18px">
          <h2 style="color:var(--brand);margin-bottom:16px">‚≠ê Enqu√™te de satisfaction</h2>
          <form id="satisfactionForm">
            <!-- Question 1 : Attentes -->
            <div class="form-group">
              <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
              <div id="starsAttentes" class="stars">
                <span class="star" data-value="1" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="2" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="3" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="4" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="5" data-group="attentes">‚òÖ</span>
              </div>
              <input type="hidden" id="noteAttentes" required>
            </div>

            <!-- Question 2 : Objectifs -->
            <div class="form-group">
              <label>Les objectifs de la formation √©taient-ils clairs et bien expliqu√©s ? *</label>
              <div id="starsObjectifs" class="stars">
                <span class="star" data-value="1" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="2" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="3" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="4" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="5" data-group="objectifs">‚òÖ</span>
              </div>
              <input type="hidden" id="noteObjectifs" required>
            </div>

            <!-- Question 3 : Formateur -->
            <div class="form-group">
              <label>Le formateur a-t-il su rendre la session claire, dynamique et adapt√©e √† votre niveau ? *</label>
              <div id="starsFormateur" class="stars">
                <span class="star" data-value="1" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="2" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="3" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="4" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="5" data-group="formateur">‚òÖ</span>
              </div>
              <input type="hidden" id="noteFormateur" required>
            </div>

            <!-- Question 4 : Utilisation logiciel -->
            <div class="form-group">
              <label>Vous sentez-vous √† l'aise pour utiliser le logiciel dans vos t√¢ches quotidiennes ? *</label>
              <div class="radio-group">
                <div class="radio-item"><input type="radio" name="utilisation" value="Pas du tout" id="util1"><label for="util1">Pas du tout</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Un peu" id="util2"><label for="util2">Un peu</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Moyennement" id="util3"><label for="util3">Moyennement</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Assez" id="util4"><label for="util4">Assez</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Tout √† fait" id="util5"><label for="util5">Tout √† fait</label></div>
              </div>
            </div>

            <!-- Question 5 : Dur√©e -->
            <div class="form-group">
              <label>Concernant la dur√©e de la formation : *</label>
              <div class="radio-group">
                <div class="radio-item"><input type="radio" name="duree" value="Trop courte" id="duree1"><label for="duree1">Trop courte</label></div>
                <div class="radio-item"><input type="radio" name="duree" value="Adapt√©e" id="duree2"><label for="duree2">Adapt√©e</label></div>
                <div class="radio-item"><input type="radio" name="duree" value="Trop longue" id="duree3"><label for="duree3">Trop longue</label></div>
              </div>
            </div>

            <!-- Question 6 : Suggestions -->
            <div class="form-group">
              <label>Quelles sont vos suggestions pour am√©liorer cette formation ?</label>
              <textarea id="suggestions" rows="3" placeholder="Vos suggestions..." maxlength="100"></textarea>
              <small id="charCountSuggestions">0/100 caract√®res</small>
            </div>

            <!-- Question 7 : Commentaire final -->
            <div class="form-group">
              <label>Un dernier commentaire ?</label>
              <textarea id="commentaireFinal" rows="3" placeholder="Votre commentaire..." maxlength="100"></textarea>
              <small id="charCountCommentaire">0/100 caract√®res</small>
            </div>

            <button type="submit" class="btn">üì§ Envoyer mon √©valuation</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Version -->
    <div class="version-info">
      <div class="version-number">Formation Manager v4.4.7</div>
      <div class="version-date">Mis √† jour le 26 novembre 2025</div>
      <div class="copyright">
        ¬© 2025 WeN√©goce - Solution de gestion des formations et √©valuations<br>
        D√©velopp√© avec ‚ù§Ô∏è pour simplifier le suivi des formations
      </div>
    </div>
  </div>

  <!-- Modale email -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Personnaliser l'email</h3>
        <button class="btn-icon" onclick="closeEmailModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet de l'email</label>
          <input type="text" id="emailSubjectEdit" placeholder="Objet de l'email">
        </div>
        <div class="form-group">
          <label>Corps de l'email</label>
          <textarea id="emailBodyEdit" rows="10" placeholder="Corps de l'email"></textarea>
          <small>Astuce: Utilisez [LIEN] dans le texte pour ins√©rer automatiquement le lien personnalis√© du stagiaire.</small>
        </div>
        <div style="text-align:right;margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeEmailModal()">Annuler</button>
          <button class="btn" onclick="saveEmailChanges()">üíæ Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale Relance -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìß Envoyer une relance</h3>
        <button class="btn-icon" onclick="closeReminderModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet de la relance</label>
          <input type="text" id="reminderSubject" placeholder="Ex: Rappel - √âvaluation de formation en attente">
        </div>
        <div class="form-group">
          <label>Message de relance</label>
          <textarea id="reminderBody" rows="8" placeholder="Votre message de relance..."></textarea>
          <small>Note: Le lien personnalis√© sera automatiquement ins√©r√© √† la fin du message.</small>
        </div>
        <div class="alert alert-info" style="margin-top:10px">‚ÑπÔ∏è <strong>Note :</strong> Le lien personnalis√© sera automatiquement ins√©r√© √† la place de [LIEN]</div>
        <div style="text-align:right;margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeReminderModal()">Annuler</button>
          <button class="btn" onclick="sendReminder()">üìß Envoyer la relance</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Helpers g√©n√©riques -->
  <script>
    function toDateISOFromInput(d){
      if(!d) return null; try{
        // Retourner juste la date sans heure pour √©viter les probl√®mes de fuseau horaire
        if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){const [dd,mm,yyyy]=d.split('/');return `${yyyy}-${mm}-${dd}`;}
      }catch(e){}
      return null;
    }
  </script>

  <!-- ============================= -->
  <!--   MSAL AUTHENTICATION V3.2    -->
  <!-- ============================= -->
  <script>
  // ============================================================================
  // CONFIGURATION ET CONSTANTES GLOBALES
  // ============================================================================
  
  // Syst√®me de logging conditionnel (mettre √† false en production)
  const DEBUG_MODE = false;
  const logger = {
    debug: (...args) => DEBUG_MODE && console.log('[DEBUG]', ...args),
    info: (...args) => console.info('[INFO]', ...args),
    warn: (...args) => console.warn('[WARN]', ...args),
    error: (...args) => console.error('[ERROR]', ...args)
  };
  
  // Constantes DOM - IDs des √©l√©ments fr√©quemment utilis√©s
  const DOM_IDS = {
    // Sections principales
    FORM_SECTION: 'formSection',
    VALIDATION_SECTION: 'validationPresenceSection',
    SATISFACTION_SECTION: 'satisfactionSection',
    
    // Formulaires
    FORMATEUR_FORM: 'formateurForm',
    SATISFACTION_FORM: 'satisfactionForm',
    
    // Listes et conteneurs
    STAGIAIRES_LIST: 'stagiairesList',
    ATTESTATION_PRESENCE: 'attestationPresence',
    
    // Inputs
    RAISON_SOCIALE: 'raisonSociale',
    THEME: 'theme',
    NOM_FORMATEUR: 'nomFormateur',
    DATE_FORMATION: 'dateFormation',
    HEURE_DEBUT: 'heureDebut',
    HEURE_FIN: 'heureFin',
    REFERENCE_JIRA: 'referenceJira',
    TYPE_FORMATION: 'typeFormation'
  };
  
  // ============================================================================
  // FONCTIONS UTILITAIRES
  // ============================================================================
  
  /**
   * Parse une valeur qui peut √™tre une cha√Æne JSON ou un objet
   * @param {*} value - Valeur √† parser
   * @returns {*} Valeur pars√©e ou valeur originale si parsing √©choue
   */
  function parseIfJSON(value) {
    if (typeof value === 'string' && value.trim().startsWith('{')) {
      try {
        return JSON.parse(value);
      } catch(e) {
        logger.warn('Failed to parse JSON:', value, e);
        return value;
      }
    }
    return value;
  }
  
  /**
   * Extrait la propri√©t√© Value d'un objet SharePoint Choice
   * @param {*} value - Valeur qui peut contenir {Value: "..."}
   * @returns {*} Valeur extraite ou valeur originale
   */
  function extractSharePointValue(value) {
    if (!value) return value;
    
    // Parser si c'est une cha√Æne JSON
    let parsed = parseIfJSON(value);
    
    // Extraire .Value si c'est un objet
    if (typeof parsed === 'object' && parsed !== null && parsed.Value) {
      return parsed.Value;
    }
    
    return parsed;
  }
  
  /**
   * Obtient un √©l√©ment DOM par son ID avec gestion d'erreur
   * @param {string} id - ID de l'√©l√©ment
   * @returns {HTMLElement|null} √âl√©ment ou null si non trouv√©
   */
  function getElement(id) {
    const element = document.getElementById(id);
    if (!element) {
      logger.warn(`Element not found: ${id}`);
    }
    return element;
  }
  
  /**
   * Affiche ou masque un √©l√©ment
   * @param {string} id - ID de l'√©l√©ment
   * @param {boolean} show - true pour afficher, false pour masquer
   */
  function toggleElement(id, show) {
    const element = getElement(id);
    if (element) {
      element.style.display = show ? 'block' : 'none';
    }
  }
  
  /**
   * Formate une date au format fran√ßais
   * @param {string|Date} date - Date √† formater
   * @returns {string} Date format√©e
   */
  function formatDateFR(date) {
    try {
      const dateObj = typeof date === 'string' ? new Date(date) : date;
      return dateObj.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch(e) {
      logger.error('Error formatting date:', date, e);
      return date?.toString() || '';
    }
  }
  
  /**
   * Attend un d√©lai (Promise-based)
   * @param {number} ms - Millisecondes √† attendre
   * @returns {Promise} Promise qui se r√©sout apr√®s le d√©lai
   */
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // ============================================================================
  // CONFIGURATION MSAL
  // ============================================================================
  
  // Configuration MSAL
  const msalConfig = {
    auth: {
      clientId: 'e270fde7-2324-487e-8cb4-c249dbafa968',
      authority: 'https://login.microsoftonline.com/bc9934d3-8db6-47e6-a844-a32a407400c2',
      redirectUri: window.location.origin + window.location.pathname
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false
    }
  };

  const loginRequest = {
    scopes: ['User.Read']
  };

  // R√¥les d'application autoris√©s (insensible √† la casse)
  const GROUPS = {
    TRAINER: 'FM.trainer',
    ADMIN: 'FM.Admin'
  };

  let msalInstance;
  let currentUser = null;

  // Initialisation MSAL
  async function initMSAL() {
    try {
      // Attendre que MSAL soit charg√©
      await window.__msalReady;
      
      msalInstance = new msal.PublicClientApplication(msalConfig);
      await msalInstance.initialize();
      
      // G√©rer le retour de redirection
      try {
        const response = await msalInstance.handleRedirectPromise();
        if (response && response.account) {
          logger.debug('Connexion r√©ussie via redirection');
          currentUser = response.account;
          msalInstance.setActiveAccount(currentUser);
          await checkUserAccess();
        } else {
          // V√©rifier si un utilisateur est d√©j√† connect√© (session existante)
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            logger.debug('Session existante trouv√©e');
            currentUser = accounts[0];
            msalInstance.setActiveAccount(currentUser);
          }
        }
      } catch (redirectError) {
        logger.error('Erreur lors de la gestion de la redirection:', redirectError);
      }
      
      updateAuthUI();
    } catch (error) {
      logger.error('Erreur initialisation MSAL:', error);
      hideLoading();
    }
  }

  // V√©rifier l'acc√®s utilisateur via les r√¥les d'application
  async function checkUserAccess() {
    if (!currentUser) {
      logger.debug('checkUserAccess: Pas d\'utilisateur connect√©');
      return false;
    }
    
    logger.debug('checkUserAccess: V√©rification pour', currentUser.username);
    
    try {
      // R√©cup√©rer les r√¥les depuis le token ID
      const roles = currentUser.idTokenClaims?.roles || [];
      
      logger.debug('R√¥les trouv√©s:', roles);
      
      // V√©rification insensible √† la casse
      const hasAccess = roles.some(role => {
        if (!role) return false;
        const roleLower = role.toLowerCase();
        return roleLower === 'fm.trainer' || roleLower === 'fm.admin';
      });
      
      logger.debug('Acc√®s autoris√©:', hasAccess);
      
      if (!hasAccess) {
        showAccessDenied();
        return false;
      }

      // Stocker le r√¥le admin
      currentUser.isAdmin = roles.some(role => {
        if (!role) return false;
        return role.toLowerCase() === 'fm.admin';
      });
      
      logger.debug('Est admin:', currentUser.isAdmin);
      return true;
      
    } catch (error) {
      logger.error('Erreur v√©rification acc√®s:', error);
      return false;
    }
  }

  // Connexion
  async function login() {
    try {
      logger.debug('Tentative de connexion...');
      showLoading();
      
      await msalInstance.loginRedirect(loginRequest);
    } catch (error) {
      logger.error('Erreur connexion:', error);
      hideLoading();
      alert('‚ùå Erreur lors de la connexion: ' + error.message);
    }
  }

  // D√©connexion
  async function logout() {
    try {
      showLoading();
      currentUser = null;
      await msalInstance.logoutRedirect({
        postLogoutRedirectUri: window.location.origin + window.location.pathname
      });
    } catch (error) {
      logger.error('Erreur d√©connexion:', error);
      hideLoading();
    }
  }

  // Mise √† jour de l'interface d'authentification
  function updateAuthUI() {
    const authSection = document.getElementById('authSection');
    
    if (currentUser) {
      const userName = currentUser.name || currentUser.username || 'Utilisateur';
      const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
      
      authSection.innerHTML = `
        <div class="user-info">
          <div class="user-avatar">${initials}</div>
        </div>
        <button class="btn-logout" onclick="logout()">D√©connexion</button>
      `;
    } else {
      authSection.innerHTML = `
        <button class="btn-login" onclick="login()">Se connecter</button>
      `;
    }
  }

  // Message d'acc√®s refus√©
  function showAccessDenied() {
    const container = document.querySelector('.container');
    const content = container.querySelector('.content');
    if (content) content.style.display = 'none';
    
    // Masquer les onglets
    const tabs = document.querySelector('.tabs');
    if (tabs) tabs.style.display = 'none';
    
    const message = document.createElement('div');
    message.style.cssText = 'text-align:center;padding:60px 20px;background:var(--card);border-radius:var(--radius);margin-top:24px;box-shadow:var(--shadow)';
    message.innerHTML = `
      <div style="font-size:64px;margin-bottom:20px">üö´</div>
      <h2 style="color:var(--danger);margin-bottom:12px">Acc√®s refus√©</h2>
      <p style="color:var(--muted);margin-bottom:24px">
        Votre compte n'a pas les autorisations n√©cessaires pour acc√©der √† Formation Manager.<br>
        Veuillez contacter votre administrateur pour obtenir l'acc√®s.
      </p>
      <button class="btn" onclick="logout()">Se d√©connecter</button>
    `;
    container.appendChild(message);
    
    // D√©placer le bloc version apr√®s le message d'acc√®s refus√©
    const versionInfo = document.querySelector('.version-info');
    if (versionInfo) {
      container.appendChild(versionInfo);
    }
  }

  // Fonction pour pr√©-remplir le nom du formateur avec l'utilisateur connect√©
  function prefillFormateurName() {
    if (currentUser) {
      const formateurInput = document.getElementById('nomFormateur');
      if (formateurInput && !formateurInput.value) {
        const userName = currentUser.name || currentUser.username || '';
        if (userName) {
          formateurInput.value = userName;
          formateurInput.classList.add('valid');
        }
      }
    }
  }

  </script>

  <!-- APP LOGIC V3.4 -->
  <script>
  let stagiaireCount=0; const MAX_STAGIAIRES=50;
  const WEBHOOK_AZURE_CREATE='https://prod-01.francecentral.logic.azure.com:443/workflows/2ed0a1ded8c04bdb919956463f324d76/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=xdDuSi6kyJazxW0euPSUkEowfVgIrgxfAQ6a6Ogejg0';
  const WEBHOOK_AZURE_CREATE_PRESENCE='https://prod-02.francecentral.logic.azure.com:443/workflows/a108ca6c917a4197ba14e2674ff31b44/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=zOjl38vl1AXhyV25ZGW_01wVLwXZwftceAYxyk8gjro';
  const WEBHOOK_GET_STAGIAIRE='https://prod-07.francecentral.logic.azure.com:443/workflows/d7804bad29a449098fb480041298d62c/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=8cWaq9BKOuc-UQvo6RliDdU6kdmHfTrPGClxtmQAZHI';
  const WEBHOOK_AZURE_SATISFACTION='https://prod-20.francecentral.logic.azure.com:443/workflows/bad15f005ef64adab56e14fd436b8a1f/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=6iHn4hVguX6pLJFyTTvbq4ujoMwF0dnCgRfy7k7hiKA';
  const WEBHOOK_AZURE_UPDATE_PRESENCE='https://prod-07.francecentral.logic.azure.com:443/workflows/b46735bd2cc149348763b27b8e4dd5eb/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=yuAu0IGbvmDfQ2brF2UKr1G0QtIA8uNBBS3Ouv3f4aA';
  const SHAREPOINT_LIST_URL='https://wenegoce.sharepoint.com/sites/FormationManager/Lists/Formations/AllItems.aspx';
  let emailSubjectGlobal="Votre formation chez WeN√©goce - Confirmation de pr√©sence";
  let emailBodyGlobal="Bonjour,\n\nNous vous remercions d'avoir particip√© √† la formation [Theme] du [Date].\n\nEn cliquant sur le lien ci-apr√®s vous acc√®derez :\n* √† une attestation de pr√©sence,\n* √† une enqu√™te de satisfaction tr√®s rapide.\n\n[LIEN]\n\nVotre avis compte pour nous et nous vous remercions de votre participation.\n\nCordialement,\n\nL'√©quipe WeN√©goce";

  function showLoading(){document.getElementById('loadingScreen').classList.add('active')}
  function hideLoading(){document.getElementById('loadingScreen').classList.remove('active')}

  // Fonction requiresAuth : retourne true si l'authentification est n√©cessaire
  function requiresAuth() {
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    // Si fid et sid existent, l'utilisateur acc√®de √† l'onglet stagiaire ‚Üí pas besoin d'auth
    if (fid && sid) {
      return false;
    }
    
    // Sinon, l'authentification est requise
    return true;
  }

  // Au chargement
  document.addEventListener('DOMContentLoaded', async function(){
    showLoading();
    
    // Initialiser MSAL (toujours)
    await initMSAL();

    // V√©rifier si l'authentification est requise
    if (requiresAuth()) {
      // Si pas d'utilisateur connect√©, demander la connexion
      if (!currentUser) {
        hideLoading();

        // Masquer le contenu principal
        const content = document.querySelector('.content');
        if (content) content.style.display = 'none';

        // Masquer les onglets
        const tabs = document.querySelector('.tabs');
        if (tabs) tabs.style.display = 'none';

        // Afficher message de connexion
        const container = document.querySelector('.container');
        const message = document.createElement('div');
        message.style.cssText = 'text-align:center;padding:60px 20px;background:var(--card);border-radius:var(--radius);margin-top:24px;box-shadow:var(--shadow)';
        message.innerHTML = `
          <div style="font-size:64px;margin-bottom:20px">üîê</div>
          <h2 style="color:var(--brand);margin-bottom:12px">Authentification requise</h2>
          <p style="color:var(--muted);margin-bottom:24px">
            Veuillez vous connecter avec votre compte Microsoft 365 pour acc√©der √† l'application.
          </p>
          <button class="btn" onclick="login()" style="font-size:16px;padding:14px 28px">Se connecter</button>
        `;
        container.appendChild(message);

        // D√©placer le bloc version apr√®s le message d'authentification
        const versionInfo = document.querySelector('.version-info');
        if (versionInfo) {
          container.appendChild(versionInfo);
        }

        return;
      }

      // L'utilisateur est connect√©, v√©rifier les droits d'acc√®s
      const hasAccess = await checkUserAccess();
      if (!hasAccess) {
        hideLoading();
        return;
      }
    }

    // Initialiser l'application
    loadFormations(); 
    addStagiaire(); // Ajouter le premier stagiaire automatiquement
    initStarRatings(); 
    initCharCounters(); 
    checkURLParams(); 
    initEventListeners(); 
    initTypeFormationToggle(); 
    setTodayDate();
    prefillFormateurName(); // Pr√©-remplir le formateur

    hideLoading();
  });

  // ===== UI helpers =====
  function setTodayDate(){
    const el=document.getElementById('dateFormation'); 
    if(el && !el.value){
      const d=new Date(),
      y=d.getFullYear(),
      m=String(d.getMonth()+1).padStart(2,'0'),
      da=String(d.getDate()).padStart(2,'0'); 
      el.value=`${y}-${m}-${da}`;
      // Valider imm√©diatement
      validateDateFormation();
    }
  }

  function switchTab(name){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
    const t=document.querySelector(`.tab[data-tab="${name}"]`),c=document.getElementById(name); 
    if(t)t.classList.add('active'); 
    if(c)c.classList.add('active'); 
    
    if(name==='formations') {
      loadFormationsTab();
    } else if(name==='nouveau') {
      prefillFormateurName();
    }
  }

  function resetForm() {
    // Afficher le formulaire et masquer la section de validation
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('validationPresenceSection').style.display = 'none';
    formationEnCours = null;
    
    // R√©initialiser le formulaire
    document.getElementById('formateurForm').reset();
    
    // Vider la liste des stagiaires
    document.getElementById('stagiairesList').innerHTML = '';
    stagiaireCount = 0;
    
    // Ajouter un stagiaire vide
    addStagiaire();
    
    // R√©initialiser la date et le formateur
    setTodayDate();
    prefillFormateurName();
    
    // Retourner √† l'onglet "nouveau"
    switchTab('nouveau');
  }

  function initEventListeners(){
    document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'));}));
    const btnAdd=document.getElementById('btnAddStagiaire'); 
    if(btnAdd) btnAdd.addEventListener('click',e=>{e.preventDefault(); addStagiaire();});
    const formateurForm=document.getElementById('formateurForm'); 
    if(formateurForm) formateurForm.addEventListener('submit',e=>{e.preventDefault(); handleFormateurSubmit();});
    
    // Validation en temps r√©el pour tous les champs obligatoires
    ['raisonSociale','theme','nomFormateur','dateFormation','heureDebut','heureFin'].forEach(id=>{
      const f=document.getElementById(id); 
      if(!f) return; 
      f.addEventListener('blur',()=>validateRequiredField(f)); 
      f.addEventListener('input',()=>{
        if(f.value.trim()) {
          validateRequiredField(f);
        } else {
          clearError(f);
        }
      });
    });
    
    const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); 
    if(hd) hd.addEventListener('change',validateHeures); 
    if(hf){
      hf.addEventListener('change',validateHeures); 
      hf.addEventListener('blur',validateHeures);
    } 
    
    const df=document.getElementById('dateFormation'); 
    if(df) df.addEventListener('change',validateDateFormation);
    
    const presenceForm=document.getElementById('presenceForm'); 
    if(presenceForm) presenceForm.addEventListener('submit',e=>{e.preventDefault(); handlePresenceSubmit();});
    
    const satisfactionForm=document.getElementById('satisfactionForm'); 
    if(satisfactionForm) satisfactionForm.addEventListener('submit',e=>{e.preventDefault(); handleSatisfactionSubmit();});
    
    const jira=document.getElementById('referenceJira'); 
    if(jira) jira.addEventListener('blur',function(){
      if(this.value.trim()) validateJiraReference(this);
    });
  }

  // ===== Validations am√©lior√©es =====
  function showError(input,msg){
    input.classList.remove('valid');
    input.classList.add('invalid');
    const ex=input.parentElement.querySelector('.error-message'); 
    if(ex) ex.remove(); 
    const s=document.createElement('small'); 
    s.className='error-message'; 
    s.textContent=msg; 
    input.parentElement.appendChild(s);
  }

  function clearError(input){
    const ex=input.parentElement.querySelector('.error-message'); 
    if(ex) ex.remove(); 
    input.classList.remove('valid');
    input.classList.remove('invalid');
  }

  function validateRequiredField(input){ 
    if(!input.value.trim()) {
      showError(input,'Ce champ est obligatoire');
      return false;
    } else {
      clearError(input); 
      input.classList.add('valid');
      return true;
    }
  }

  function validateEmail(input){
    const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
    if(input.value.trim() && !re.test(input.value)) {
      showError(input,'Format email invalide');
      return false;
    } else if(input.value.trim()){
      clearError(input); 
      input.classList.add('valid');
      return true;
    }
    return true;
  }

  function validateJiraReference(input){
    const r=/^(TIC|SMC|SNC)-\d+$/i; 
    if(input.value.trim() && !r.test(input.value)) {
      showError(input,'Format JIRA invalide (ex: TIC-123)');
      return false;
    } else if(input.value.trim()){
      clearError(input); 
      input.classList.add('valid');
      return true;
    }
    return true;
  }

  function validateDateFormation(){
    const el=document.getElementById('dateFormation'); 
    const d=new Date(el.value), today=new Date(); 
    today.setHours(0,0,0,0); 
    const min=new Date(); 
    min.setDate(today.getDate()-7); 
    
    if(d<min){
      showError(el,'La date ne peut pas √™tre ant√©rieure √† plus de 7 jours');
      return false;
    } else {
      clearError(el); 
      el.classList.add('valid');
      return true;
    }
  }

  function validateHeures(){
    const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); 
    if(hd.value && hf.value){
      const [a,b]=hd.value.split(':').map(Number), [c,d]=hf.value.split(':').map(Number); 
      if((c*60+d) <= (a*60+b)) {
        showError(hf,"L'heure de fin doit √™tre apr√®s l'heure de d√©but");
        return false;
      } else {
        clearError(hf); 
        hf.classList.add('valid');
        hd.classList.add('valid');
        return true;
      }
    }
    return true;
  }

  function initTypeFormationToggle(){
    const t=document.getElementById('typeFormationToggle'), 
    lp=document.getElementById('labelPresentiel'), 
    lv=document.getElementById('labelVisio'); 
    if(!t) return; 
    t.addEventListener('change',function(){ 
      if(this.checked){
        lp.classList.remove('active'); 
        lv.classList.add('active');
      } else {
        lp.classList.add('active'); 
        lv.classList.remove('active');
      }
    })
  }

  // ===== Gestion stagiaires =====
  function addStagiaire(){ 
    if(stagiaireCount>=MAX_STAGIAIRES){
      alert('‚ö†Ô∏è Maximum de '+MAX_STAGIAIRES+' stagiaires atteint'); 
      return;
    } 
    stagiaireCount++; 
    const c=document.getElementById('stagiairesList'); 
    const d=document.createElement('div'); 
    d.className='stagiaire-item'; 
    d.id='stagiaire-'+stagiaireCount; 
    d.innerHTML=`
    <div class="stagiaire-header">
      <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
      <button type="button" class="btn-remove" onclick="removeStagiaire(${stagiaireCount})">üóëÔ∏è Supprimer</button>
    </div>
    <div class="row">
      <div class="form-group">
        <label>Nom complet *</label>
        <input type="text" id="nomStagiaire${stagiaireCount}" required>
      </div>
      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="emailStagiaire${stagiaireCount}" required>
      </div>
    </div>`; 
    c.appendChild(d);
    
    // Ajouter les validations sur les nouveaux champs
    const nomInput=document.getElementById('nomStagiaire'+stagiaireCount);
    if(nomInput){
      nomInput.addEventListener('blur',function(){validateRequiredField(this)}); 
      nomInput.addEventListener('input',function(){
        if(this.value.trim()) validateRequiredField(this);
      });
    }
    
    const emailInput=document.getElementById('emailStagiaire'+stagiaireCount); 
    if(emailInput){
      emailInput.addEventListener('blur',function(){validateEmail(this)}); 
      emailInput.addEventListener('input',function(){
        if(this.value.trim()) validateEmail(this);
      });
    }
  }

  function removeStagiaire(id){
    const it=document.getElementById('stagiaire-'+id); 
    if(it){
      it.remove(); 
      stagiaireCount--;
    }
  }

  // ===== Submit formation -> Azure =====
  async function handleFormateurSubmit(){
    // Valider tous les champs obligatoires
    const raisonSociale=document.getElementById('raisonSociale');
    const theme=document.getElementById('theme');
    const nomFormateur=document.getElementById('nomFormateur');
    const dateFormation=document.getElementById('dateFormation');
    const heureDebut=document.getElementById('heureDebut');
    const heureFin=document.getElementById('heureFin');

    let isValid = true;

    // Validation des champs principaux
    if(!validateRequiredField(raisonSociale)) isValid = false;
    if(!validateRequiredField(theme)) isValid = false;
    if(!validateRequiredField(nomFormateur)) isValid = false;
    if(!validateRequiredField(dateFormation)) isValid = false;
    if(!validateDateFormation()) isValid = false;
    if(!validateRequiredField(heureDebut)) isValid = false;
    if(!validateRequiredField(heureFin)) isValid = false;
    if(!validateHeures()) isValid = false;

    // Validation de la r√©f√©rence JIRA si remplie
    const referenceJira=document.getElementById('referenceJira');
    if(referenceJira.value.trim() && !validateJiraReference(referenceJira)) isValid = false;

    // Validation des stagiaires
    const stagiaires=[];
    for(let i=1; i<=stagiaireCount; i++){
      const nomSt=document.getElementById('nomStagiaire'+i);
      const emailSt=document.getElementById('emailStagiaire'+i);

      if(nomSt && emailSt){
        if(!validateRequiredField(nomSt)) isValid = false;
        if(!validateEmail(emailSt)) isValid = false;

        if(nomSt.value.trim() && emailSt.value.trim()){
          stagiaires.push({
            id: 'ST-' + Date.now() + '-' + i,
            nom: nomSt.value.trim(),
            email: emailSt.value.trim()
          });
        }
      }
    }

    if(!isValid){
      alert('‚ö†Ô∏è Veuillez corriger les erreurs dans le formulaire avant de continuer.');
      return;
    }

    if(stagiaires.length === 0){
      alert('‚ö†Ô∏è Veuillez ajouter au moins un stagiaire.');
      return;
    }

    const typeFormation=document.getElementById('typeFormationToggle').checked ? 'Visio':'Pr√©sentiel';
    const formationID = 'FM-' + Date.now();

    // Payload envoy√© au Logic App de cr√©ation de formation
    const payloadFormation={
      FormationID: formationID,
      Client: raisonSociale.value.trim(),
      Theme: theme.value.trim(),
      ReferenceJIRA: referenceJira.value.trim(),
      Formateur: nomFormateur.value.trim(),
      Date: toDateISOFromInput(dateFormation.value),
      TypeFormation: typeFormation,
      HeureDebut: heureDebut.value,
      HeureFin: heureFin.value,
      Statut: 'Planifi√©e'
    };

    // Payload pour la cr√©ation des pr√©sences (appel s√©par√©)
    const payloadPresence = {
      FormationID: formationID,
      Stagiaires: stagiaires.map(s => ({
        id: s.id,
        nom: s.nom,
        email: s.email,
        presence: '',
        commentaire: ''
      }))
    };

    showLoading();
    try{
      // 1. Cr√©ation de la formation dans SharePoint
      logger.debug('√âtape 1/3 : Cr√©ation de la formation...');
      const resFormation = await fetch(WEBHOOK_AZURE_CREATE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payloadFormation)
      });

      if(!resFormation.ok){
        const txt = await resFormation.text();
        throw new Error('Erreur Azure (cr√©ation formation): ' + resFormation.status + ' - ' + txt);
      }

      logger.debug('‚úì Formation cr√©√©e, attente de 1 seconde...');
      await new Promise(resolve => setTimeout(resolve, 1000));

      // 2. Cr√©ation des pr√©sences dans SharePoint
      logger.debug('√âtape 2/3 : Cr√©ation des pr√©sences...');
      const resPresence = await fetch(WEBHOOK_AZURE_CREATE_PRESENCE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payloadPresence)
      });

      if(!resPresence.ok){
        const txt = await resPresence.text();
        logger.warn('Avertissement lors de la cr√©ation des pr√©sences:', resPresence.status, txt);
        // Ne pas bloquer, continuer quand m√™me
      } else {
        logger.debug('‚úì Pr√©sences cr√©√©es');
      }

      logger.debug('Attente de 2 secondes pour la synchronisation SharePoint...');
      await new Promise(resolve => setTimeout(resolve, 2000));

      // 3. R√©cup√©rer les donn√©es fra√Æches depuis SharePoint avec FM-GetStagiaire
      logger.debug('√âtape 3/3 : R√©cup√©ration des donn√©es depuis SharePoint...');
      
      const resGet = await fetch(WEBHOOK_GET_STAGIAIRE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          FormationID: formationID,
          StagiaireID: stagiaires[0].id // Premier stagiaire pour r√©cup√©rer toute la formation
        })
      });

      if(!resGet.ok){
        const txt = await resGet.text();
        throw new Error('Erreur Azure (r√©cup√©ration formation): ' + resGet.status + ' - ' + txt);
      }

      const dataFromSharePoint = await resGet.json();
      logger.debug('Donn√©es r√©cup√©r√©es depuis SharePoint:', dataFromSharePoint);

      // Normaliser le TypeFormation (peut √™tre un objet {Value: "Pr√©sentiel"})
      let typeFormationValue = dataFromSharePoint.TypeFormation || typeFormation;
      if (typeFormationValue && typeof typeFormationValue === 'object' && typeFormationValue.Value) {
        typeFormationValue = typeFormationValue.Value;
      }

      // Normaliser les stagiaires depuis SharePoint
      let stagiairesFromSP = dataFromSharePoint.Stagiaires || [];
      if (typeof stagiairesFromSP === 'string') {
        try {
          stagiairesFromSP = JSON.parse(stagiairesFromSP);
        } catch(e) {
          logger.error('Erreur parsing Stagiaires:', e);
          stagiairesFromSP = [];
        }
      }

      // Si pas de stagiaires dans SharePoint, utiliser les stagiaires locaux
      if (!Array.isArray(stagiairesFromSP) || stagiairesFromSP.length === 0) {
        stagiairesFromSP = stagiaires.map(s => ({
          StagiaireID: s.id,
          Nom: s.nom,
          Email: s.email,
          Presence: '',
          Commentaire: '',
          Satisfaction: null
        }));
      } else {
        // Normaliser les stagiaires de SharePoint
        stagiairesFromSP = stagiairesFromSP.map(s => ({
          StagiaireID: s.StagiaireID || s.id || s.stagiaireId || '',
          Nom: s.Nom || s.nom || s.NomStagiaire || '',
          Email: s.Email || s.email || s.mail || '',
          Presence: s.Presence || s.presence || '',
          Commentaire: s.Commentaire || s.commentaire || '',
          Satisfaction: s.Satisfaction || s.satisfaction || null
        }));
      }

      // Construire le payload √† partir des donn√©es SharePoint
      const payloadFromSharePoint = {
        FormationID: formationID,
        Client: dataFromSharePoint.Client || dataFromSharePoint.RaisonSociale || raisonSociale.value.trim(),
        Theme: dataFromSharePoint.Theme || theme.value.trim(),
        ReferenceJIRA: dataFromSharePoint.ReferenceJIRA || referenceJira.value.trim(),
        Formateur: dataFromSharePoint.Formateur || dataFromSharePoint.NomFormateur || nomFormateur.value.trim(),
        Date: dataFromSharePoint.Date || toDateISOFromInput(dateFormation.value),
        TypeFormation: typeFormationValue,
        HeureDebut: dataFromSharePoint.HeureDebut || heureDebut.value,
        HeureFin: dataFromSharePoint.HeureFin || heureFin.value,
        Statut: dataFromSharePoint.Statut || 'Planifi√©e',
        Stagiaires: JSON.stringify(stagiairesFromSP)
      };

      logger.debug('Payload construit pour validation:', payloadFromSharePoint);

      // Afficher la page de validation des pr√©sences avec les donn√©es fra√Æches
      afficherValidationPresences(payloadFromSharePoint);

    } catch(err){
      logger.error(err);
      alert('‚ùå Erreur lors de l\'enregistrement: ' + err.message);
    } finally {
      hideLoading();
    }
  }


// ===== Chargement formations depuis SharePoint =====
  let formationsCacheSP = [];
  
  async function loadFormations() {
    try {
      // Pour l'instant, on utilise un tableau vide car on n'a pas d'acc√®s direct √† SharePoint
      formationsCacheSP = [];
    } catch(err) {
      logger.error('Erreur chargement formations:', err);
    }
  }

  function loadFormationsTab() {
    const list = document.getElementById('formationsList');
    
    if(formationsCacheSP.length === 0) {
      list.innerHTML = `
        <div class="alert alert-info">
          <p style="margin:0">üìã Aucune formation enregistr√©e pour le moment.</p>
          <p style="margin:8px 0 0 0;font-size:13px">
            Les formations que vous cr√©ez appara√Ætront automatiquement dans SharePoint: 
            <a href="${SHAREPOINT_LIST_URL}" target="_blank" style="color:var(--brand)">
              Ouvrir SharePoint
            </a>
          </p>
        </div>`;
      return;
    }
    
    // Afficher les formations
    let html = '';
    formationsCacheSP.forEach(f => {
      const dateStr = new Date(f.date).toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      html += `
        <div class="formation-card">
          <div style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
              <div>
                <h3 style="margin:0 0 6px 0;color:var(--brand)">${f.theme}</h3>
                <div style="color:var(--muted);font-size:14px">${f.raisonSociale}</div>
              </div>
              <span style="background:var(--brand-50);color:var(--brand);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">${f.type}</span>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:12px;font-size:13px">
              <div><strong>üìÖ Date:</strong> ${dateStr}</div>
              <div><strong>üïê Horaires:</strong> ${f.heureDebut} - ${f.heureFin}</div>
              <div><strong>üë®‚Äçüè´ Formateur:</strong> ${f.nomFormateur}</div>
              <div><strong>üë• Stagiaires:</strong> ${f.stagiaires.length}</div>
            </div>
          </div>
        </div>`;
    });
    
    list.innerHTML = html;
  }

  // ===== Satisfaction =====
  function initStarRatings() {
    // G√©rer les 3 groupes d'√©toiles s√©par√©ment
    const starGroups = ['attentes', 'objectifs', 'formateur'];
    
    starGroups.forEach(groupName => {
      const container = document.getElementById('stars' + groupName.charAt(0).toUpperCase() + groupName.slice(1));
      const noteInput = document.getElementById('note' + groupName.charAt(0).toUpperCase() + groupName.slice(1));
      
      if (!container || !noteInput) return;
      
      const stars = container.querySelectorAll('.star[data-group="' + groupName + '"]');
      
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          noteInput.value = value;
          updateStarsGroup(groupName, value);
        });
        
        star.addEventListener('mouseenter', function() {
          const value = this.getAttribute('data-value');
          updateStarsGroup(groupName, value);
        });
      });
      
      container.addEventListener('mouseleave', function() {
        const currentValue = noteInput.value;
        updateStarsGroup(groupName, currentValue);
      });
    });
  }

  function updateStarsGroup(groupName, value) {
    const stars = document.querySelectorAll('.star[data-group="' + groupName + '"]');
    stars.forEach(star => {
      if (star.getAttribute('data-value') <= value) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }

  function initCharCounters() {
    const suggestions = document.getElementById('suggestions');
    const commentaireFinal = document.getElementById('commentaireFinal');
    
    if(suggestions) {
      suggestions.addEventListener('input', function() {
        document.getElementById('charCountSuggestions').textContent = 
          this.value.length + '/100 caract√®res';
      });
    }
    
    if(commentaireFinal) {
      commentaireFinal.addEventListener('input', function() {
        document.getElementById('charCountCommentaire').textContent = 
          this.value.length + '/100 caract√®res';
      });
    }
  }

  async function handleSatisfactionSubmit() {
    // R√©cup√©rer toutes les valeurs du formulaire
    const noteAttentes = document.getElementById('noteAttentes').value;
    const noteObjectifs = document.getElementById('noteObjectifs').value;
    const noteFormateur = document.getElementById('noteFormateur').value;
    const utilisation = document.querySelector('input[name="utilisation"]:checked');
    const duree = document.querySelector('input[name="duree"]:checked');
    const suggestions = document.getElementById('suggestions').value.trim();
    const commentaireFinal = document.getElementById('commentaireFinal').value.trim();
    
    // Validations
    if(!noteAttentes) {
      alert('‚ö†Ô∏è Veuillez √©valuer si la formation a r√©pondu √† vos attentes.');
      return;
    }
    
    if(!noteObjectifs) {
      alert('‚ö†Ô∏è Veuillez √©valuer si les objectifs √©taient clairs.');
      return;
    }
    
    if(!noteFormateur) {
      alert('‚ö†Ô∏è Veuillez √©valuer la qualit√© du formateur.');
      return;
    }
    
    if(!utilisation) {
      alert('‚ö†Ô∏è Veuillez indiquer votre niveau d\'aisance avec le logiciel.');
      return;
    }
    
    if(!duree) {
      alert('‚ö†Ô∏è Veuillez indiquer votre avis sur la dur√©e de la formation.');
      return;
    }
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    // Convertir "utilisation" en nombre (1-5)
    // "Pas du tout" = 1, "Un peu" = 2, "Moyennement" = 3, "Assez" = 4, "Tout √† fait" = 5
    const utilisationMap = {
      "Pas du tout": 1,
      "Un peu": 2,
      "Moyennement": 3,
      "Assez": 4,
      "Tout √† fait": 5
    };
    const q4Value = utilisationMap[utilisation.value] || 3;
    
    // Convertir "duree" en nombre (1-3)
    // "Trop courte" = 1, "Adapt√©e" = 2, "Trop longue" = 3
    const dureeMap = {
      "Trop courte": 1,
      "Adapt√©e": 2,
      "Trop longue": 3
    };
    const q5Value = dureeMap[duree.value] || 2;
    
    // R√©cup√©rer le nom du stagiaire (stock√© globalement lors du chargement)
    const nomStagiaire = window.currentStagiaireNom || "Stagiaire";
    
    const payload = {
      FormationID: fid,
      StagiaireID: sid,
      NomStagiaire: nomStagiaire,
      Q1: parseInt(noteAttentes),
      Q2: parseInt(noteObjectifs),
      Q3: parseInt(noteFormateur),
      Q4: q4Value,
      Q5: q5Value,
      Suggestions: suggestions,
      CommentairesStagiaire: commentaireFinal
    };
    
    logger.debug('Payload satisfaction:', payload);
    
    showLoading();
    try {
      const res = await fetch(WEBHOOK_AZURE_SATISFACTION, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok) {
        const errorText = await res.text();
        throw new Error('Erreur lors de l\'envoi: ' + errorText);
      }
      
      // Calculer la moyenne des notes pour l'affichage
      const noteMoyenne = Math.round((parseInt(noteAttentes) + parseInt(noteObjectifs) + parseInt(noteFormateur)) / 3);
      displayThankYouMessage(noteMoyenne, 'Merci pour votre retour !');
    } catch(err) {
      logger.error(err);
      alert('‚ùå Erreur lors de l\'envoi: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  function displayThankYouMessage(note, message) {
    const emoji = note >= 4 ? 'üéâ' : note >= 3 ? 'üòä' : 'üí≠';
    
    // Afficher le message de remerciement apr√®s l'attestation
    const thankYouHTML = `
      <div class="alert alert-success" style="margin-top:16px;text-align:center">
        <div style="font-size:48px;margin-bottom:10px">${emoji}</div>
        <h3 style="color:var(--success);margin:0 0 8px 0">${message}</h3>
        <p style="margin:0">Votre √©valuation a bien √©t√© enregistr√©e. Merci pour votre participation √† cette formation.</p>
      </div>`;
    
    // Ajouter le message apr√®s l'attestation
    document.getElementById('attestationPresence').innerHTML += thankYouHTML;
    
    // Masquer le formulaire de satisfaction
    const satisfactionCard = document.getElementById('satisfactionForm').closest('.card');
    if (satisfactionCard) {
      satisfactionCard.style.display = 'none';
    }
  }

  // ===== Pr√©sence =====
  async function handlePresenceSubmit() {
    const presence = document.querySelector('input[name="presence"]:checked');
    const commentaire = document.getElementById('commentaireFormateur').value.trim();
    
    if(!presence) {
      alert('‚ö†Ô∏è Veuillez s√©lectionner un statut de pr√©sence.');
      return;
    }
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    const payload = {
      FormationID: fid,
      StagiaireID: sid,
      Presence: presence.value,
      Commentaire: commentaire
    };
    
    showLoading();
    try {
      const res = await fetch(WEBHOOK_AZURE_UPDATE_PRESENCE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok) throw new Error('Erreur lors de la mise √† jour');
      
      alert('‚úÖ Pr√©sence enregistr√©e avec succ√®s !');
      window.location.reload();
    } catch(err) {
      logger.error(err);
      alert('‚ùå Erreur: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  // ===== Email =====
  function saveEmailChanges() {
    emailSubjectGlobal = document.getElementById('emailSubjectEdit').value;
    emailBodyGlobal = document.getElementById('emailBodyEdit').value;
    updateEmailPreview();
    closeEmailModal();
  }

  // ===== V√©rification des param√®tres URL =====
  function checkURLParams() {
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    if(fid && sid) {
      // Masquer tous les onglets sauf stagiaire
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        const tabName = tab.getAttribute('data-tab');
        if (tabName !== 'stagiaire') {
          tab.style.display = 'none';
        } else {
          tab.style.display = 'inline-block';
        }
      });
      
      // Passer √† l'onglet stagiaire
      switchTab('stagiaire');
      loadStagiaireView(fid, sid);
    }
  }

  function loadStagiaireView(fid, sid) {
    showLoading();
    
    // Appeler FM-GetStagiaire pour r√©cup√©rer les donn√©es
    fetch(WEBHOOK_GET_STAGIAIRE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        FormationID: fid,
        StagiaireID: sid
      })
    })
    .then(res => {
      if (!res.ok) throw new Error('Erreur lors du chargement des donn√©es');
      return res.json();
    })
    .then(data => {
      logger.debug('Donn√©es re√ßues de FM-GetStagiaire:', data);
      
      // Trouver le stagiaire dans le tableau
      let stagiaire = null;
      if (data.Stagiaires && Array.isArray(data.Stagiaires)) {
        stagiaire = data.Stagiaires.find(s => s.StagiaireID === sid || s.id === sid);
      }
      
      if (!stagiaire) {
        logger.warn('Stagiaire non trouv√© dans les donn√©es, utilisation du premier');
        stagiaire = data.Stagiaires && data.Stagiaires.length > 0 ? data.Stagiaires[0] : {};
      }
      
      // Construire l'objet de donn√©es pour l'affichage
      const formationData = {
        Client: data.Client || data.RaisonSociale || "Non renseign√©",
        NomStagiaire: stagiaire.Nom || stagiaire.NomStagiaire || stagiaire.nom || "Non renseign√©",
        Theme: data.Theme || "Non renseign√©",
        Date: data.Date || "Non renseign√©e",
        HeureDebut: data.HeureDebut || "Non renseign√©e",
        HeureFin: data.HeureFin || "Non renseign√©e",
        Presence: extractSharePointValue(stagiaire.Presence || stagiaire.presence) || "En attente",
        CommentaireFormateur: stagiaire.Commentaire || stagiaire.CommentaireFormateur || stagiaire.commentaire || ""
      };
      
      // Afficher l'attestation de pr√©sence
      displayAttestation(formationData, fid, sid);
      hideLoading();
    })
    .catch(err => {
      logger.error('Erreur chargement formation:', err);
      document.getElementById('attestationPresence').innerHTML = `
        <div class="alert alert-warning">
          ‚ö†Ô∏è Erreur lors du chargement des donn√©es. Veuillez r√©essayer plus tard.
          <br><small>D√©tail: ${err.message}</small>
        </div>`;
      hideLoading();
    });
  }
  
  function displayAttestation(data, fid, sid) {
    // Normaliser le champ Presence avec la fonction utilitaire
    data.Presence = extractSharePointValue(data.Presence) || "En attente";
    logger.debug('Presence normalis√©e:', data.Presence);
    
    // Formater la date avec la fonction utilitaire
    const dateFormatted = data.Date && data.Date !== "Chargement..." 
      ? formatDateFR(data.Date) 
      : data.Date;
    
    // D√©terminer l'emoji et la couleur de pr√©sence
    const presenceConfig = {
      "Present": { emoji: "‚úÖ", color: "var(--success)" },
      "Partielle": { emoji: "‚è±Ô∏è", color: "var(--warning)" },
      "Absent": { emoji: "‚ùå", color: "var(--danger)" }
    };
    const { emoji: presenceEmoji = "‚è≥", color: presenceColor = "#6b7280" } = presenceConfig[data.Presence] || {};
    
    // Construire le HTML de l'attestation
    const attestationElement = getElement(DOM_IDS.ATTESTATION_PRESENCE);
    if (!attestationElement) {
      logger.error('Element attestationPresence not found');
      return;
    }
    
    attestationElement.innerHTML = `
      <div class="info-row">
        <div class="info-label">Client :</div>
        <div><strong>${data.Client || "Non renseign√©"}</strong></div>
      </div>
      <div class="info-row">
        <div class="info-label">Nom du stagiaire :</div>
        <div><strong>${data.NomStagiaire || "Non renseign√©"}</strong></div>
      </div>
      <div class="info-row">
        <div class="info-label">Th√®me de la formation :</div>
        <div><strong>${data.Theme || "Non renseign√©"}</strong></div>
      </div>
      <div class="info-row">
        <div class="info-label">Date de la formation :</div>
        <div>${dateFormatted || "Non renseign√©e"}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Heure de d√©but :</div>
        <div>${data.HeureDebut || "Non renseign√©e"}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Heure de fin :</div>
        <div>${data.HeureFin || "Non renseign√©e"}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Pr√©sence :</div>
        <div style="color:${presenceColor};font-weight:bold">${presenceEmoji} ${data.Presence || "En attente"}</div>
      </div>
      ${data.CommentaireFormateur ? `
      <div class="info-row">
        <div class="info-label">Commentaire formateur :</div>
        <div style="font-style:italic">${data.CommentaireFormateur}</div>
      </div>
      ` : ''}
      <div style="margin-top:16px;padding:12px;background:var(--brand-50);border-radius:8px;font-size:13px">
        <strong>‚ÑπÔ∏è Note :</strong> Cette attestation de pr√©sence est g√©n√©r√©e automatiquement suite √† votre participation √† la formation. 
        Les informations de pr√©sence ont √©t√© valid√©es par le formateur.
      </div>
    `;
    
    // Masquer l'enqu√™te de satisfaction si le stagiaire est Absent
    const isAbsent = data.Presence === "Absent";
    toggleElement(DOM_IDS.SATISFACTION_SECTION, !isAbsent);
    logger.debug(`Enqu√™te de satisfaction ${isAbsent ? 'masqu√©e' : 'affich√©e'} - Pr√©sence: ${data.Presence}`);
    
    // Sauvegarder les IDs et le nom pour l'envoi du formulaire de satisfaction
    window.currentFormationID = fid;
    window.currentStagiaireID = sid;
    window.currentStagiaireNom = data.NomStagiaire || "Stagiaire";
  }

  // ===== CORRECTION : Fonction transformAzureFormation avec fermeture correcte =====
  function transformAzureFormation(sp){
    if(!sp) return null;

    // R√©cup√©ration des stagiaires (formats vari√©s)
    let stagiaires = [];
    if(sp.Stagiaires !== undefined){
      const raw = sp.Stagiaires;
      if(typeof raw === 'string'){
        try{ stagiaires = JSON.parse(raw); }catch{ stagiaires = []; }
      } else if(Array.isArray(raw)){
        stagiaires = raw;
      } else if(raw && typeof raw === 'object'){
        stagiaires = [raw];
      }
    } else if(sp.stagiaires){
      stagiaires = sp.stagiaires;
    }

    // Normalisation de la date
    let date = sp.DateFormation || sp.Date || sp.date;
    if(date && typeof date === 'string' && date.includes('T')){
      date = date.split('T')[0];
    }

    // Normalisation du type de formation (Pr√©sentiel / Visio)
    let type = extractSharePointValue(sp.TypeFormation || sp.type) || '';

    // Normalisation des stagiaires (pr√©sence, commentaire, etc.)
    stagiaires = (stagiaires || []).map(s => {
      // Normaliser la pr√©sence avec la fonction utilitaire
      let presence = extractSharePointValue(s.presence || s.Presence || s.statut || s.Statut) || '';

      // Normaliser le format de la pr√©sence
      if(typeof presence === 'string'){
        const pl = presence.toLowerCase();
        if(pl.startsWith('pr√©sent') || pl === 'present') presence = 'Present';
        else if(pl.startsWith('absent')) presence = 'Absent';
        else if(pl.startsWith('partiel')) presence = 'Partielle';
      }

      return {
        id: s.id || s.StagiaireID || s.stagiaireId || '',
        nom: s.nom || s.Nom || s.NomStagiaire || '',
        email: s.email || s.Email || s.mail || '',
        presence,
        commentaire: s.commentaire || s.Commentaire || s.CommentaireFormateur || '',
        satisfaction: s.satisfaction || null
      };
    });

    return {
      id: sp.FormationID || sp.id,
      raisonSociale: sp.RaisonSociale || sp.Client || sp.raisonSociale || '',
      theme: sp.Theme || sp.theme || '',
      referenceJira: sp.ReferenceJIRA || sp.ReferenceJira || sp.referenceJira || '',
      nomFormateur: sp.Formateur || sp.NomFormateur || sp.nomFormateur || '',
      date: date || '',
      type,
      heureDebut: sp.HeureDebut || sp.heureDebut || '',
      heureFin: sp.HeureFin || sp.heureFin || '',
      stagiaires
    };
  }

  // ===== Modales email =====
  function openEmailModal(){
    document.getElementById('emailSubjectEdit').value=emailSubjectGlobal; 
    document.getElementById('emailBodyEdit').value=emailBodyGlobal; 
    document.getElementById('emailModal').style.display='flex';
  }
  
  function closeEmailModal(){
    document.getElementById('emailModal').style.display='none'
  }

  // Mettre √† jour le preview du mod√®le d'email
  function updateEmailPreview() {
    const subjectPreview = document.getElementById('emailSubjectPreview');
    const bodyPreview = document.getElementById('emailBodyPreview');
    
    if (subjectPreview) {
      subjectPreview.textContent = emailSubjectGlobal;
    }
    
    if (bodyPreview && formationEnCours) {
      // Formater la date de la formation
      const dateFormation = new Date(formationEnCours.Date).toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Remplacer [Theme], [Date] et [LIEN] dans le preview
      const previewBody = emailBodyGlobal
        .replace('[Theme]', formationEnCours.Theme)
        .replace('[Date]', dateFormation)
        .replace('[LIEN]', 'üîó Lien personnalis√© du stagiaire');
      
      bodyPreview.textContent = previewBody;
    }
  }

  // ===== Validation des pr√©sences =====
  let formationEnCours = null;

  function afficherValidationPresences(payload) {
    // Sauvegarder la formation en cours
    formationEnCours = payload;
    
    // Masquer le formulaire
    document.getElementById('formSection').style.display = 'none';
    
    // Afficher la section de validation
    document.getElementById('validationPresenceSection').style.display = 'block';
    
    // Masquer l'onglet "Cr√©er une formation"
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      const tabName = tab.getAttribute('data-tab');
      if (tabName === 'nouveau') {
        tab.style.display = 'none';
      }
    });
    
    // Afficher les infos de la formation
    const dateStr = new Date(payload.Date).toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    document.getElementById('formationInfoValidation').innerHTML = `
      <div class="info-row"><div class="info-label">Client :</div><div><strong>${payload.Client}</strong></div></div>
      <div class="info-row"><div class="info-label">Th√®me :</div><div><strong>${payload.Theme}</strong></div></div>
      <div class="info-row"><div class="info-label">Formateur :</div><div>${payload.Formateur}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${dateStr}</div></div>
      <div class="info-row"><div class="info-label">Horaires :</div><div>${payload.HeureDebut} - ${payload.HeureFin}</div></div>
      <div class="info-row"><div class="info-label">Type :</div><div>${payload.TypeFormation}</div></div>
    `;
    
    // R√©cup√©rer les stagiaires depuis le JSON stringifi√©
    const stagiaires = JSON.parse(payload.Stagiaires);
    
    // Afficher la liste des stagiaires
    let html = '';
    stagiaires.forEach((st, index) => {
      html += `
        <div class="stagiaire-item" id="validation-stagiaire-${index}">
          <div class="stagiaire-header">
            <h3 class="stagiaire-number" style="margin:0">${st.Nom}</h3>
            <button class="btn btn-edit" onclick="envoyerEmailStagiaire(${index})">üìß Envoi du mail</button>
          </div>
          <div>
            <div style="color:var(--muted);font-size:14px;margin-bottom:16px">üìß ${st.Email}</div>
            <div class="form-group">
              <label style="font-weight:700">Pr√©sence</label>
              <div class="presence-radio-group">
                <div class="presence-item">
                  <input type="radio" name="presence-${index}" value="Present" id="present-${index}" onchange="marquerPresence(${index}, 'Present')">
                  <label for="present-${index}">‚úÖ Pr√©sent</label>
                </div>
                <div class="presence-item">
                  <input type="radio" name="presence-${index}" value="Partielle" id="partielle-${index}" onchange="marquerPresence(${index}, 'Partielle')">
                  <label for="partielle-${index}">‚è±Ô∏è Partielle</label>
                </div>
                <div class="presence-item">
                  <input type="radio" name="presence-${index}" value="Absent" id="absent-${index}" onchange="marquerPresence(${index}, 'Absent')">
                  <label for="absent-${index}">‚ùå Absent</label>
                </div>
              </div>
            </div>
            <div class="form-group" style="margin-top:12px">
              <label style="font-weight:700">Commentaire (optionnel)</label>
              <textarea id="commentaire-${index}" rows="3" placeholder="Ex: D√©part anticip√©..." onchange="marquerCommentaire(${index})"></textarea>
            </div>
          </div>
        </div>
      `;
    });
    
    document.getElementById('stagiairePresenceList').innerHTML = html;
    
    // Mettre √† jour le preview du mod√®le d'email
    updateEmailPreview();
  }

  function marquerPresence(index, presence) {
    if (!formationEnCours) return;
    
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    stagiaires[index].Presence = presence;
    formationEnCours.Stagiaires = JSON.stringify(stagiaires);
    
    logger.debug('Pr√©sence marqu√©e:', stagiaires[index].Nom, '-', presence);
  }

  function marquerCommentaire(index) {
    if (!formationEnCours) return;
    
    const commentaire = document.getElementById('commentaire-' + index).value.trim();
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    stagiaires[index].Commentaire = commentaire;
    formationEnCours.Stagiaires = JSON.stringify(stagiaires);
    
    logger.debug('Commentaire ajout√© pour:', stagiaires[index].Nom);
  }

  function envoyerEmailStagiaire(index) {
    if (!formationEnCours) return;
    
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    const stagiaire = stagiaires[index];
    
    // Construire le lien personnalis√©
    const link = `${window.location.origin}${window.location.pathname}?fid=${formationEnCours.FormationID}&sid=${stagiaire.StagiaireID}`;
    
    // Payload pour la mise √† jour de la pr√©sence
    const updatePayload = {
      FormationID: formationEnCours.FormationID,
      StagiaireID: stagiaire.StagiaireID,
      Presence: stagiaire.Presence || '',
      Commentaire: stagiaire.Commentaire || ''
    };
    
    logger.debug('Mise √† jour de la pr√©sence pour:', stagiaire.Nom, updatePayload);
    
    // Mise √† jour Azure avant l'envoi de l'email
    fetch(WEBHOOK_AZURE_UPDATE_PRESENCE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatePayload)
    })
    .then(res => {
      if (!res.ok) {
        logger.error('Erreur mise √† jour pr√©sence:', res.status, res.statusText);
        return res.text().then(txt => logger.error('D√©tail erreur:', txt));
      }
      logger.debug('‚úì Pr√©sence mise √† jour avec succ√®s pour:', stagiaire.Nom);
    })
    .catch(err => {
      logger.error('Erreur r√©seau mise √† jour pr√©sence:', err);
    });
    
    // Formater la date de la formation
    const dateFormation = new Date(formationEnCours.Date).toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Remplacer [LIEN], [Theme] et [Date] dans le corps de l'email
    const body = emailBodyGlobal
      .replace('[LIEN]', link)
      .replace('[Theme]', formationEnCours.Theme)
      .replace('[Date]', dateFormation);
    
    // Ouvrir le client de messagerie
    const mailtoLink = `mailto:${stagiaire.Email}?subject=${encodeURIComponent(emailSubjectGlobal)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
  }

  function envoyerTousEmails() {
    if (!formationEnCours) return;
    
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    
    // Formater la date de la formation
    const dateFormation = new Date(formationEnCours.Date).toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    logger.debug(`Envoi de ${stagiaires.length} emails et mise √† jour des pr√©sences...`);
    
    // D√©tecter Chrome
    const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
    
    if (isChrome) {
      // Mode Chrome : Confirmation interactive pour chaque email
      let currentIndex = 0;
      
      function envoyerEmailSuivant() {
        if (currentIndex >= stagiaires.length) {
          alert('‚úÖ Tous les emails ont √©t√© envoy√©s !');
          return;
        }
        
        const stagiaire = stagiaires[currentIndex];
        const link = `${window.location.origin}${window.location.pathname}?fid=${formationEnCours.FormationID}&sid=${stagiaire.StagiaireID}`;
        
        // Payload pour la mise √† jour
        const updatePayload = {
          FormationID: formationEnCours.FormationID,
          StagiaireID: stagiaire.StagiaireID,
          Presence: stagiaire.Presence || '',
          Commentaire: stagiaire.Commentaire || ''
        };
        
        logger.debug(`[${currentIndex + 1}/${stagiaires.length}] Mise √† jour pr√©sence pour:`, stagiaire.Nom);
        
        // Mise √† jour Azure
        fetch(WEBHOOK_AZURE_UPDATE_PRESENCE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatePayload)
        })
        .then(res => {
          if (!res.ok) {
            logger.error(`‚ùå Erreur mise √† jour pr√©sence pour ${stagiaire.Nom}:`, res.status);
          } else {
            logger.debug(`‚úì Pr√©sence mise √† jour pour ${stagiaire.Nom}`);
          }
        })
        .catch(err => {
          logger.error(`‚ùå Erreur r√©seau pour ${stagiaire.Nom}:`, err);
        });
        
        // Remplacer [LIEN], [Theme] et [Date] dans le corps de l'email
        const body = emailBodyGlobal
          .replace('[LIEN]', link)
          .replace('[Theme]', formationEnCours.Theme)
          .replace('[Date]', dateFormation);
        
        const mailtoLink = `mailto:${stagiaire.Email}?subject=${encodeURIComponent(emailSubjectGlobal)}&body=${encodeURIComponent(body)}`;
        
        // Ouvrir l'email
        logger.debug(`üìß Ouverture client email pour: ${stagiaire.Nom} (${stagiaire.Email})`);
        window.location.href = mailtoLink;
        
        currentIndex++;
        
        // Demander confirmation pour continuer (apr√®s un d√©lai pour que l'email s'ouvre)
        setTimeout(() => {
          if (currentIndex < stagiaires.length) {
            const continuer = confirm(`Email ${currentIndex}/${stagiaires.length} envoy√©.\n\nVoulez-vous envoyer l'email suivant ?\n\nStagiaire suivant : ${stagiaires[currentIndex].Nom}`);
            if (continuer) {
              envoyerEmailSuivant();
            } else {
              alert(`‚è∏Ô∏è Envoi interrompu.\n${currentIndex} email(s) envoy√©(s) sur ${stagiaires.length}.`);
            }
          } else {
            alert('‚úÖ Tous les emails ont √©t√© envoy√©s !');
          }
        }, 1000);
      }
      
      // Message d'information initial
      const commencer = confirm(`üìß Mode Chrome d√©tect√©\n\n${stagiaires.length} emails vont √™tre envoy√©s.\n\nUne confirmation sera demand√©e avant chaque email.\n\nCommencer l'envoi ?`);
      if (commencer) {
        envoyerEmailSuivant();
      }
      
    } else {
      // Mode automatique pour Safari/Firefox
      function openMailto(mailtoLink) {
        const a = document.createElement('a');
        a.href = mailtoLink;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
      
      // Traiter chaque stagiaire s√©quentiellement
      stagiaires.forEach((stagiaire, index) => {
        const link = `${window.location.origin}${window.location.pathname}?fid=${formationEnCours.FormationID}&sid=${stagiaire.StagiaireID}`;
        
        // Payload pour la mise √† jour
        const updatePayload = {
          FormationID: formationEnCours.FormationID,
          StagiaireID: stagiaire.StagiaireID,
          Presence: stagiaire.Presence || '',
          Commentaire: stagiaire.Commentaire || ''
        };
        
        logger.debug(`[${index + 1}/${stagiaires.length}] Mise √† jour pr√©sence pour:`, stagiaire.Nom);
        
        // Mise √† jour Azure
        fetch(WEBHOOK_AZURE_UPDATE_PRESENCE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatePayload)
        })
        .then(res => {
          if (!res.ok) {
            logger.error(`‚ùå Erreur mise √† jour pr√©sence pour ${stagiaire.Nom}:`, res.status);
          } else {
            logger.debug(`‚úì Pr√©sence mise √† jour pour ${stagiaire.Nom}`);
          }
        })
        .catch(err => {
          logger.error(`‚ùå Erreur r√©seau pour ${stagiaire.Nom}:`, err);
        });
        
        // Remplacer [LIEN], [Theme] et [Date] dans le corps de l'email
        const body = emailBodyGlobal
          .replace('[LIEN]', link)
          .replace('[Theme]', formationEnCours.Theme)
          .replace('[Date]', dateFormation);
        
        const mailtoLink = `mailto:${stagiaire.Email}?subject=${encodeURIComponent(emailSubjectGlobal)}&body=${encodeURIComponent(body)}`;
        
        // Ouvrir avec un d√©lai de 2 secondes entre chaque email
        setTimeout(() => {
          logger.debug(`üìß Ouverture client email pour: ${stagiaire.Nom} (${stagiaire.Email})`);
          openMailto(mailtoLink);
        }, index * 2000);
      });
      
      // Message d'information
      const totalTime = stagiaires.length * 2;
      alert(`üìß Envoi en cours...\n\n${stagiaires.length} fen√™tres d'email vont s'ouvrir successivement.\nTemps estim√©: ${totalTime} secondes.\n\nVeuillez ne pas fermer cette page pendant l'envoi.`);
    }
  }

  function retourFormulaire() {
    document.getElementById('validationPresenceSection').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    formationEnCours = null;
  }

  function terminerValidation() {
    // R√©initialiser compl√®tement
    document.getElementById('validationPresenceSection').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    formationEnCours = null;
    
    // R√©initialiser le formulaire
    resetForm();
    
    alert('‚úÖ Validation termin√©e ! La formation a √©t√© enregistr√©e.');
  }

  // Expose pour onClick inline
  window.switchTab=switchTab; 
  window.addStagiaire=addStagiaire; 
  window.removeStagiaire=removeStagiaire;
  window.openEmailModal=openEmailModal; 
  window.closeEmailModal=closeEmailModal; 
  window.saveEmailChanges=saveEmailChanges;
  window.resetForm=resetForm;
  window.marquerPresence=marquerPresence;
  window.marquerCommentaire=marquerCommentaire;
  window.envoyerEmailStagiaire=envoyerEmailStagiaire;
  window.envoyerTousEmails=envoyerTousEmails;
  window.retourFormulaire=retourFormulaire;
  window.terminerValidation=terminerValidation;
  
  // Gestionnaire d'erreurs global pour debug
  window.addEventListener('error', function(event) {
    logger.error('Erreur globale captur√©e:', {
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
      error: event.error
    });
  });
  
  // Gestionnaire pour les promesses non g√©r√©es
  window.addEventListener('unhandledrejection', function(event) {
    logger.error('Promise rejet√©e non g√©r√©e:', event.reason);
  });
  </script>
</body>
</html>
